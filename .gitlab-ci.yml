# Copyright (c) 2017 Siemens AG
# Author: Alfonso Ros Dos Santos

# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:

# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

docker-image:
  stage: deploy
  script:
    - 'IMAGE_NAME=docker.web-of-systems.com/lava-ctl'
    - 'docker build 
          --build-arg http_proxy=$http_proxy 
          --build-arg https_proxy=$http_proxy 
          --build-arg user=$LAVA_USER 
          --build-arg token=$LAVA_TOKEN
          --build-arg master_addr=$LAVA_SERVER_ADDR
          --build-arg ftp_user=$LAVA_STORAGE_FTP_USER
          --build-arg ftp_pass=$LAVA_STORAGE_FTP_PASS
          --build-arg ssh_priv="$SSH_PRIVATE_KEY"
          -t $IMAGE_NAME .'
    - if [ "$CI_BUILD_REF_NAME" == "master" ]; then
    -   'docker tag $IMAGE_NAME $IMAGE_NAME:$(cat VERSION)'
    -   'docker push $IMAGE_NAME'
    - else
    -   'version="$(cat VERSION)-$(git rev-parse --short HEAD)"'
    -   'docker tag $IMAGE_NAME $IMAGE_NAME:$version'
    -   'docker push $IMAGE_NAME:$version'
    - fi
  tags:
    - RAW
